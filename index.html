<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼ì„ ìœ„í•˜ì—¬</title>
    <style>
        :root {
            color-scheme: light dark;
        }
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            background: #f6f8fa;
            color: #222;
        }
        /* ì¶•í•˜ ë°°ê²½ (ë¹„ë°€ë²ˆí˜¸ ê³µê°œ í™”ë©´ ì „ìš©) */
        body.celebrate {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 25%, #ffd1ff 50%, #c2e9fb 75%, #a1c4fd 100%);
            background-size: 300% 300%;
            animation: bgShift 12s ease infinite;
        }
        @keyframes bgShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .screen {
            display: none;
            min-height: 100%;
        }
        .screen.active { display: flex; }
        .center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .card {
            width: 100%;
            max-width: 560px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            padding: 24px;
            text-align: center;
        }
        h1 {
            margin: 0 0 16px;
            font-size: 24px;
        }
        p { margin: 0 0 24px; font-size: 16px; }
        .primary-btn {
            display: inline-block;
            padding: 14px 20px;
            font-size: 18px;
            font-weight: 700;
            background: #e11d48; /* rose-600 */
            color: #fff;
            border: none;
            border-radius: 999px;
            width: 100%;
            max-width: 360px;
            cursor: pointer;
            transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
            box-shadow: 0 6px 14px rgba(225, 29, 72, 0.35);
        }
        .primary-btn:active { transform: translateY(1px); }
        /* í™ˆ íˆì–´ë¡œ ì´ë¯¸ì§€ */
        .hero-wrap { margin: 14px 0 18px; }
        .hero-img {
            width: 100%;
            max-width: 420px;
            height: auto;
            display: inline-block;
            border-radius: 16px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.12), 0 6px 16px rgba(0,0,0,0.08);
            background: radial-gradient(120% 120% at 10% 0%, rgba(255,182,193,0.35) 0%, rgba(255,255,255,0) 60%),
                        radial-gradient(120% 120% at 100% 100%, rgba(161,196,253,0.35) 0%, rgba(255,255,255,0) 60%);
            padding: 6px; /* ì€ì€í•œ ê¸€ë¡œìš° ì—¬ë°± */
            animation: floatY 5.5s ease-in-out infinite;
        }
        @keyframes floatY {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @media (prefers-reduced-motion: reduce) {
            .hero-img { animation: none; }
        }
        .question {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .subtle { color: #6b7280; font-size: 14px; }
        /* ì„ íƒì§€ ê·¸ë¦¬ë“œ */
        .choices-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        .choice-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            color: inherit;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
        }
        .choice-btn:focus { outline: 3px solid #fb7185; outline-offset: 2px; }
        .choice-btn:active { transform: translateY(1px); }
        .choice-btn img {
            width: 100%;
            height: auto;
            max-height: 160px;
            object-fit: contain;
        }
        .choice-caption {
            margin-top: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        /* íƒ„ì§€ë¡œ í€´ì¦ˆ ì„ íƒì§€ í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ ë³´ì • */
        .tanjiro-quiz .choice-caption {
            margin-top: 0; /* ì´ë¯¸ì§€ ìº¡ì…˜ìš© ì—¬ë°± ì œê±° â†’ ë²„íŠ¼ ë‚´ ì •í™•í•œ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
        }
        @media (prefers-color-scheme: dark) {
            html, body { background: #0b0f14; color: #e5e7eb; }
            .card { background: #111827; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
            .subtle { color: #9ca3af; }
            .choice-btn { background: #0f172a; border-color: #334155; }
            .hero-img { box-shadow: 0 18px 40px rgba(0,0,0,0.45), 0 6px 16px rgba(0,0,0,0.35); }
        }
        /* ë¹„ë°€ë²ˆí˜¸ ê³µê°œ ìŠ¤íƒ€ì¼ */
        #passwordScreen .card { text-align: center; }
        .pw-fireworks { font-size: 28px; margin: 6px 0 10px; }
        .pw-box {
            display: inline-flex;
            gap: 10px;
            margin: 10px 0 6px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.6);
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12), inset 0 0 20px rgba(255,255,255,0.35);
            backdrop-filter: blur(6px);
        }
        .digit {
            width: 48px;
            height: 64px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 900;
            color: #111827;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            text-shadow: 0 2px 0 rgba(0,0,0,0.06);
        }
        @media (prefers-color-scheme: dark) {
            body.celebrate { background: linear-gradient(135deg, #1f2937 0%, #0ea5e9 40%, #8b5cf6 70%, #f472b6 100%); }
            .pw-box { background: rgba(17,24,39,0.5); box-shadow: 0 8px 24px rgba(0,0,0,0.35), inset 0 0 16px rgba(255,255,255,0.08); }
            .digit { background: #0b1220; color: #e5e7eb; }
        }
        /* ìŒì„± ì¸ì‹ UI (ë¬´ì´ì¹˜ë¡œ ì „ìš©) */
        .record-wrap { margin-top: 16px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .record-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 999px;
            border: none;
            background: #ef4444; /* red-500 */
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(239, 68, 68, .35);
            transition: transform .05s ease, background .2s ease, box-shadow .2s ease;
        }
        .record-btn:active { transform: translateY(1px); }
        .record-btn[disabled] { opacity: .6; cursor: not-allowed; box-shadow: none; }
        .status-text { font-size: 14px; color: #6b7280; }
        .transcript {
            width: 100%;
            text-align: left;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            min-height: 72px;
            white-space: pre-wrap;
        }
        @media (prefers-color-scheme: dark) {
            .transcript { background: #0f172a; border-color: #334155; }
        }
        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(0,0,0,0.1);
            border-top-color: #e11d48;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-message { font-size: 14px; color: #6b7280; }
    </style>
    <script>
        function show(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            const el = document.getElementById(screenId);
            if (el) el.classList.add('active');
        }
        const characters = [
            { slug: 'kamado-nezuko', src: 'images/characters/kamado_nezuko.png', label: 'ì¹´ë§ˆë„ ë„¤ì¦ˆì½”', nextQuestion: 'ë„¤ì¦ˆì½”ë¥¼ ì¢‹ì•„í•˜ëŠ” ê°€ì¥ í° ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?' },
            { slug: 'kamado-tanjiro', src: 'images/characters/kamado_tanjiro.png', label: 'ì¹´ë§ˆë„ íƒ„ì§€ë¡œ', nextQuestion: 'íƒ„ì§€ë¡œì²˜ëŸ¼ ì°©í•œ í–‰ë™ í•œ ê°€ì§€ë¥¼ ì ì–´ë³¼ê¹Œìš”?' },
            { slug: 'tokito-muichiro', src: 'images/characters/tokito_muichiro.png', label: 'í† í‚¤í†  ë¬´ì´ì¹˜ë¡œ', nextQuestion: 'ë¬´ì´ì¹˜ë¡œì˜ ë§¤ë ¥ í¬ì¸íŠ¸ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?' },
            { slug: 'tomioka-giyu', src: 'images/characters/tomioka_giyu.png', label: 'í† ë¯¸ì˜¤ì¹´ ê¸°ìœ ', nextQuestion: 'ê¸°ìœ ì˜ ê°€ì¥ ë©‹ì§„ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?' },
        ];

        // Web Speech API (ë¬´ì´ì¹˜ë¡œ/ê¸°ìœ  ì „ìš©)
        let muichiroRecognition = null;
        let muichiroRecognizing = false;
        let muichiroBound = false;
        let muichiroSuccessShown = false;
        let giyuRecognition = null;
        let giyuRecognizing = false;
        let giyuBound = false;
        let giyuSuccessShown = false;
        // ë¹„ë°€ë²ˆí˜¸ í™”ë©´ ì „ ë¡œë”© ì „í™˜ìš© íƒ€ì´ë¨¸
        let passwordLoadingTimer = null;
        // ë¹„ë°€ë²ˆí˜¸ í™”ë©´ ì§„ì… ì¶œì²˜(íƒ„ì§€ë¡œ/ë¬´ì´ì¹˜ë¡œ/ê¸°ìœ )ë¥¼ ì¶”ì í•´ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë¶„ê¸°
        // ê°’ ì˜ˆ: 'tanjiro' | 'muichiro' | 'giyu' | null
        let lastPasswordSource = null;

        // ì„±ê³µ í‚¤ì›Œë“œ íŒì •: "í˜¸í¡" AND ("ì•ˆê°œ" OR "ì•ˆëŒ€")
        function muichiroMatchesSuccessKeywords(text) {
            if (!text) return false;
            const normalized = String(text).replace(/\s+/g, '').toLowerCase();
            const hasBreath = normalized.includes('í˜¸í¡');
            const hasFogOrAlt = normalized.includes('ì•ˆê°œ') || normalized.includes('ì•ˆëŒ€');
            return hasBreath && hasFogOrAlt;
        }

        // ì„±ê³µ í‚¤ì›Œë“œ íŒì •(ê¸°ìœ ): "ë¬¼" AND "í˜¸í¡"
        function giyuMatchesSuccessKeywords(text) {
            if (!text) return false;
            const normalized = String(text).replace(/\s+/g, '').toLowerCase();
            return normalized.includes('í˜¸í¡') && normalized.includes('ë¬¼');
        }

        function getSpeechRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return null;
            if (muichiroRecognition) return muichiroRecognition;
            const rec = new SR();
            rec.lang = 'ko-KR';
            rec.interimResults = true;
            rec.continuous = true;

            const statusEl = () => document.getElementById('muichiro-status');
            const btnEl = () => document.getElementById('muichiro-record-btn');
            const outEl = () => document.getElementById('muichiro-transcript');

            rec.onstart = () => {
                muichiroRecognizing = true;
                if (statusEl()) statusEl().textContent = 'ë…¹ìŒ ì¤‘â€¦ ì£¼ë¬¸ì„ ìŠì–´ë³´ì•„ìš”!';
                if (btnEl()) btnEl().textContent = 'ë…¹ìŒ ì¤‘ì§€';
            };
            rec.onend = () => {
                muichiroRecognizing = false;
                // if (statusEl()) statusEl().textContent = 'ì¸ì‹ ì¢…ë£Œë¨';
                if (btnEl()) btnEl().textContent = 'ë…¹ìŒ ì‹œì‘';
            };
            rec.onerror = (e) => {
                if (statusEl()) statusEl().textContent = `ì˜¤ë¥˜: ${e.error || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
            };
            rec.onresult = (event) => {
                let finalText = '';
                let interimText = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const res = event.results[i];
                    if (res.isFinal) finalText += res[0].transcript;
                    else interimText += res[0].transcript;
                }
                const out = outEl();
                if (out) {
                    const base = out.dataset.base || '';
                    const combined = (base + ' ' + finalText + (interimText ? ' ' + interimText : '')).trim();
                    out.textContent = combined;

                    // í‚¤ì›Œë“œ ê°ì§€: ("ì•ˆê°œ" & "í˜¸í¡") ë˜ëŠ” ("ì•ˆëŒ€" & "í˜¸í¡")
                    const success = muichiroMatchesSuccessKeywords(combined);
                    if (!muichiroSuccessShown && success) {
                        muichiroSuccessShown = true;
                        try { rec.stop(); } catch {}
                        const status = document.getElementById('muichiro-status');
                        if (status) status.textContent = 'ì„±ê³µ! ì£¼ë¬¸ì´ ì¸ì‹ë˜ì—ˆì–´ìš” ğŸ‰';
                        // ì ê¹ì˜ UI ë°˜ì˜ í›„ ë¡œë”© í™”ë©´ -> ë¹„ë°€ë²ˆí˜¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                        setTimeout(() => {
                            // ì¶œì²˜ í‘œì‹œ: ë¬´ì´ì¹˜ë¡œ ì„±ê³µ ê²½ë¡œ
                            lastPasswordSource = 'muichiro';
                            showLoadingBeforePassword();
                        }, 400);
                    } else if (finalText && !success) {
                        // ì¡°ê±´ ë¶ˆì¶©ì¡± ì‹œ ì¬ë„ì „ ë©”ì‹œì§€ í‘œì‹œ (ìµœì¢… ê²°ê³¼ê°€ ìˆì„ ë•Œì—ë§Œ í‘œì‹œ)
                        const status = document.getElementById('muichiro-status');
                        if (status) status.textContent = 'ë‹¤ì‹œ ë„ì „í•´ ì£¼ì„¸ìš”!';
                    }
                }
            };
            muichiroRecognition = rec;
            return rec;
        }

        // ê¸°ìœ ìš© ìŒì„± ì¸ì‹ê¸° ìƒì„±/ë°˜í™˜
        function getGiyuSpeechRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return null;
            if (giyuRecognition) return giyuRecognition;
            const rec = new SR();
            rec.lang = 'ko-KR';
            rec.interimResults = true;
            rec.continuous = true;

            const statusEl = () => document.getElementById('giyu-status');
            const btnEl = () => document.getElementById('giyu-record-btn');
            const outEl = () => document.getElementById('giyu-transcript');

            rec.onstart = () => {
                giyuRecognizing = true;
                if (statusEl()) statusEl().textContent = 'ë…¹ìŒ ì¤‘â€¦ ì£¼ë¬¸ì„ ìŠì–´ë³´ì•„ìš”!';
                if (btnEl()) btnEl().textContent = 'ë…¹ìŒ ì¤‘ì§€';
            };
            rec.onend = () => {
                giyuRecognizing = false;
                if (btnEl()) btnEl().textContent = 'ë…¹ìŒ ì‹œì‘';
            };
            rec.onerror = (e) => {
                if (statusEl()) statusEl().textContent = `ì˜¤ë¥˜: ${e.error || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
            };
            rec.onresult = (event) => {
                let finalText = '';
                let interimText = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const res = event.results[i];
                    if (res.isFinal) finalText += res[0].transcript;
                    else interimText += res[0].transcript;
                }
                const out = outEl();
                if (out) {
                    const base = out.dataset.base || '';
                    const combined = (base + ' ' + finalText + (interimText ? ' ' + interimText : '')).trim();
                    out.textContent = combined;

                    // í‚¤ì›Œë“œ ê°ì§€: ("ë¬¼" & "í˜¸í¡")
                    const success = giyuMatchesSuccessKeywords(combined);
                    if (!giyuSuccessShown && success) {
                        giyuSuccessShown = true;
                        try { rec.stop(); } catch {}
                        const status = document.getElementById('giyu-status');
                        if (status) status.textContent = 'ì„±ê³µ! ì£¼ë¬¸ì´ ì¸ì‹ë˜ì—ˆì–´ìš” ğŸ‰';
                        setTimeout(() => {
                            // ì¶œì²˜ í‘œì‹œ: ê¸°ìœ  ì„±ê³µ ê²½ë¡œ
                            lastPasswordSource = 'giyu';
                            showLoadingBeforePassword();
                        }, 400);
                    } else if (finalText && !success) {
                        const status = document.getElementById('giyu-status');
                        if (status) status.textContent = 'ë‹¤ì‹œ ë„ì „í•´ ì£¼ì„¸ìš”!';
                    }
                }
            };
            giyuRecognition = rec;
            return rec;
        }

        function muichiroToggleRecording() {
            const rec = getSpeechRecognition();
            const btn = document.getElementById('muichiro-record-btn');
            const status = document.getElementById('muichiro-status');
            if (!rec) {
                if (status) status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš” ğŸ˜¢ (Chrome/Android ê¶Œì¥)';
                if (btn) btn.disabled = true;
                return;
            }
            if (muichiroRecognizing) {
                try { rec.stop(); } catch {}
            } else {
                try {
                    // iOS Safari ë“±ì€ ì‚¬ìš©ì ì œìŠ¤ì²˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ
                    rec.start();
                } catch (e) {
                    if (status) status.textContent = 'ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
            }
        }

        function giyuToggleRecording() {
            const rec = getGiyuSpeechRecognition();
            const btn = document.getElementById('giyu-record-btn');
            const status = document.getElementById('giyu-status');
            if (!rec) {
                if (status) status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš” ğŸ˜¢ (Chrome/Android ê¶Œì¥)';
                if (btn) btn.disabled = true;
                return;
            }
            if (giyuRecognizing) {
                try { rec.stop(); } catch {}
            } else {
                try {
                    rec.start();
                } catch (e) {
                    if (status) status.textContent = 'ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
            }
        }

        function initMuichiroScreen() {
            // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
            const btn = document.getElementById('muichiro-record-btn');
            const status = document.getElementById('muichiro-status');
            const out = document.getElementById('muichiro-transcript');
            if (!btn || !status || !out) return;

            // í•œ ë²ˆë§Œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            if (!muichiroBound) {
                btn.addEventListener('click', muichiroToggleRecording);
                muichiroBound = true;
            }
            // ì´ˆê¸° ìƒíƒœ ë¦¬ì…‹
            status.textContent = 'ëŒ€ê¸° ì¤‘';
            btn.textContent = 'ë…¹ìŒ ì‹œì‘';
            btn.disabled = false;
            out.textContent = '';
            muichiroSuccessShown = false;

            // ì§€ì› ì—¬ë¶€ í‘œì‹œ
            if (!getSpeechRecognition()) {
                status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš” ğŸ˜¢ (Chrome/Android ê¶Œì¥)';
                btn.disabled = true;
            }
        }

        function teardownMuichiro() {
            if (muichiroRecognition && muichiroRecognizing) {
                try { muichiroRecognition.stop(); } catch {}
            }
        }

        function initGiyuScreen() {
            const btn = document.getElementById('giyu-record-btn');
            const status = document.getElementById('giyu-status');
            const out = document.getElementById('giyu-transcript');
            if (!btn || !status || !out) return;

            if (!giyuBound) {
                btn.addEventListener('click', giyuToggleRecording);
                giyuBound = true;
            }
            status.textContent = 'ëŒ€ê¸° ì¤‘';
            btn.textContent = 'ë…¹ìŒ ì‹œì‘';
            btn.disabled = false;
            out.textContent = '';
            giyuSuccessShown = false;

            if (!getGiyuSpeechRecognition()) {
                status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš” ğŸ˜¢ (Chrome/Android ê¶Œì¥)';
                btn.disabled = true;
            }
        }

        function teardownGiyu() {
            if (giyuRecognition && giyuRecognizing) {
                try { giyuRecognition.stop(); } catch {}
            }
        }

        function ensureCharacterScreensOnce() {
            // ê° ìºë¦­í„° ì „ìš© ì§ˆë¬¸ í™”ë©´ì„ 1íšŒë§Œ ìƒì„±
            if (document.body.dataset.charScreens === 'true') return;
            const frag = document.createDocumentFragment();
            characters.forEach(c => {
                const main = document.createElement('main');
                main.id = `char-${c.slug}`;
                main.className = 'screen';
                main.setAttribute('aria-live', 'polite');
                if (c.slug === 'tokito-muichiro') {
                    main.innerHTML = `
                        <div class="center">
                            <div class="card" role="region" aria-labelledby="title-${c.slug}">
                                <h1 id="title-${c.slug}" class="question">ì¢‹ì•„ìš”! â€œ${c.label}â€ë¥¼ ì„ íƒí–ˆë„¤ìš”</h1>
                                <p class="subtle">ì‹œìœ ë‹ˆê°€ ${c.label}ë¼ê³  ìƒê°í–ˆì„ ë•Œ, <br>ì„ ë¬¼ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•Œì•„ë‚´ê¸°ìœ„í•´ ì£¼ë¬¸ì„ ìŠì–´ë³¼ê¹Œìš”?</p>
                                <div class="record-wrap">
                                    <button id="muichiro-record-btn" type="button" class="record-btn" aria-live="polite">ë…¹ìŒ ì‹œì‘</button>
                                    <div id="muichiro-status" class="status-text" aria-live="polite">ëŒ€ê¸° ì¤‘</div>
                                    <div id="muichiro-transcript" class="transcript" role="textbox" aria-label="ì¸ì‹ëœ ì£¼ë¬¸ í…ìŠ¤íŠ¸"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (c.slug === 'tomioka-giyu') {
                    main.innerHTML = `
                        <div class="center">
                            <div class="card" role="region" aria-labelledby="title-${c.slug}">
                                <h1 id="title-${c.slug}" class="question">ì¢‹ì•„ìš”! â€œ${c.label}â€ë¥¼ ì„ íƒí–ˆë„¤ìš”</h1>
                                <p class="subtle">ì‹œìœ ë‹ˆê°€ ${c.label}ë¼ê³  ìƒê°í–ˆì„ ë•Œ, <br>ì„ ë¬¼ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•Œì•„ë‚´ê¸°ìœ„í•´ ì£¼ë¬¸ì„ ìŠì–´ë³¼ê¹Œìš”?</p>
                                <div class="record-wrap">
                                    <button id="giyu-record-btn" type="button" class="record-btn" aria-live="polite">ë…¹ìŒ ì‹œì‘</button>
                                    <div id="giyu-status" class="status-text" aria-live="polite">ëŒ€ê¸° ì¤‘</div>
                                    <div id="giyu-transcript" class="transcript" role="textbox" aria-label="ì¸ì‹ëœ ì£¼ë¬¸ í…ìŠ¤íŠ¸"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (c.slug === 'kamado-tanjiro') {
                    // íƒ„ì§€ë¡œ ì „ìš© 4ì§€ì„ ë‹¤ í€´ì¦ˆ í™”ë©´
                    main.innerHTML = `
                        <div class="center">
                            <div class="card" role="region" aria-labelledby="title-${c.slug}">
                                <h1 id="title-${c.slug}" class="question">ì¢‹ì•„ìš”! â€œ${c.label}â€ë¥¼ ì„ íƒí–ˆë„¤ìš”</h1>
                                <p class="subtle" style="margin-bottom:16px;">íƒ„ì§€ë¡œëŠ” ì—¬ë™ìƒì„ ì¸ê°„ìœ¼ë¡œ ë˜ëŒë¦¬ê³  ê°€ì¡±ì˜ ë³µìˆ˜ë¥¼ í•˜ê¸°ìœ„í•´ OOOì— ë“¤ì–´ê°€ê²Œ ë˜ëŠ”ë°, OOOëŠ” ë¬´ì—‡ì¼ê¹Œ?</p>
                                <div class="choices-grid tanjiro-quiz" role="group" aria-label="íƒ„ì§€ë¡œ í€´ì¦ˆ ë³´ê¸°">
                                    <button type="button" class="choice-btn" aria-label="1ë²ˆ ê·€ì—½ëŒ€" onclick="handleTanjiroAnswer(1)">
                                        <div class="choice-caption">1. ê·€ì—½ëŒ€</div>
                                    </button>
                                    <button type="button" class="choice-btn" aria-label="2ë²ˆ ê·€ì‚´ëŒ€" onclick="handleTanjiroAnswer(2)">
                                        <div class="choice-caption">2. ê·€ì‚´ëŒ€</div>
                                    </button>
                                    <button type="button" class="choice-btn" aria-label="3ë²ˆ ì‚´ì‚´ëŒ€" onclick="handleTanjiroAnswer(3)">
                                        <div class="choice-caption">3. ì‚´ì‚´ëŒ€</div>
                                    </button>
                                    <button type="button" class="choice-btn" aria-label="4ë²ˆ ê¸°ì›ƒëŒ€" onclick="handleTanjiroAnswer(4)">
                                        <div class="choice-caption">4. ê¸°ì›ƒëŒ€</div>
                                    </button>
                                </div>
                                <p id="tanjiro-feedback" class="subtle" aria-live="polite" style="min-height:20px; margin-top:14px;"></p>
                            </div>
                        </div>
                    `;
                } else if (c.slug === 'kamado-nezuko') {
                    // ë„¤ì¦ˆì½” ì „ìš© 4ì§€ì„ ë‹¤ í€´ì¦ˆ í™”ë©´ (ì´ë¯¸ì§€ ë³´ê¸°)
                    main.innerHTML = `
                        <div class="center">
                            <div class="card" role="region" aria-labelledby="title-${c.slug}">
                                <h1 id="title-${c.slug}" class="question">ì¢‹ì•„ìš”! â€œ${c.label}â€ë¥¼ ì„ íƒí–ˆë„¤ìš”</h1>
                                <p class="subtle" style="margin-bottom:16px;">ë‹¤ìŒì¤‘ ë„¤ì¦ˆì½”ì˜ ë¬¼ê±´ì€?</p>
                                <div class="choices-grid" role="group" aria-label="ë„¤ì¦ˆì½” í€´ì¦ˆ ë³´ê¸°">
                                    <button type="button" class="choice-btn" aria-label="1ë²ˆ ë³´ê¸°" onclick="handleNezukoAnswer(1)">
                                        <img src="images/properties/1mace.png" alt="ë³´ê¸° 1">
                                        <div class="choice-caption">1</div>
                                    </button>
                                    <button type="button" class="choice-btn" aria-label="2ë²ˆ ë³´ê¸°" onclick="handleNezukoAnswer(2)">
                                        <img src="images/properties/2nichirin.png" alt="ë³´ê¸° 2">
                                        <div class="choice-caption">2</div>
                                    </button>
                                    <button type="button" class="choice-btn" aria-label="3ë²ˆ ë³´ê¸° (ì •ë‹µ)" onclick="handleNezukoAnswer(3)">
                                        <img src="images/properties/3bambu.png" alt="ë³´ê¸° 3">
                                        <div class="choice-caption">3</div>
                                    </button>
                                    <button type="button" class="choice-btn" aria-label="4ë²ˆ ë³´ê¸°" onclick="handleNezukoAnswer(4)">
                                        <img src="images/properties/4sinobu.png" alt="ë³´ê¸° 4">
                                        <div class="choice-caption">4</div>
                                    </button>
                                </div>
                                <p id="nezuko-feedback" class="subtle" aria-live="polite" style="min-height:20px; margin-top:14px;"></p>
                            </div>
                        </div>
                    `;
                } else {
                    main.innerHTML = `
                        <div class="center">
                            <div class="card" role="region" aria-labelledby="title-${c.slug}">
                                <h1 id="title-${c.slug}" class="question">ì¢‹ì•„ìš”! â€œ${c.label}â€ë¥¼ ì„ íƒí–ˆë„¤ìš”</h1>
                                <p class="subtle">ë‹¤ìŒ ì§ˆë¬¸: ${c.nextQuestion}</p>
                            </div>
                        </div>
                    `;
                }
                frag.appendChild(main);
            });
            // ë¹„ë°€ë²ˆí˜¸ ì§„ì… ì „ ì ê¹ ë³´ì´ëŠ” ë¡œë”© í™”ë©´
            const loading = document.createElement('main');
            loading.id = 'loadingScreen';
            loading.className = 'screen';
            loading.setAttribute('aria-live', 'polite');
            loading.innerHTML = `
                <div class="center">
                    <div class="card" role="status" aria-label="ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”">
                        <div class="loader" aria-hidden="true"></div>
                        <div class="loading-message">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì—¬ëŠ” ì¤‘â€¦</div>
                    </div>
                </div>
            `;
            frag.appendChild(loading);
            document.body.appendChild(frag);
            document.body.dataset.charScreens = 'true';
        }

        function renderChoicesOnce() {
            const container = document.getElementById('choicesContainer');
            if (!container || container.dataset.rendered === 'true') return;
            const frag = document.createDocumentFragment();
            characters.forEach((c, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'choice-btn';
                btn.setAttribute('role', 'option');
                btn.setAttribute('aria-label', c.label);
                btn.dataset.index = String(idx);
                const img = document.createElement('img');
                img.src = c.src;
                img.alt = c.label;
                const cap = document.createElement('div');
                cap.className = 'choice-caption';
                cap.textContent = c.label;
                btn.appendChild(img);
                btn.appendChild(cap);
                btn.addEventListener('click', () => {
                    // ì„ íƒ ì‹œ ìºë¦­í„° ì „ìš© ì§ˆë¬¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                    goToCharacter(c.slug);
                });
                frag.appendChild(btn);
            });
            container.appendChild(frag);
            container.dataset.rendered = 'true';
        }
        function clearPasswordLoadingTimer() {
            if (passwordLoadingTimer) {
                clearTimeout(passwordLoadingTimer);
                passwordLoadingTimer = null;
            }
        }
        function showLoadingBeforePassword() {
            // ë…¹ìŒ ì¤‘ì§€ ë° ë¡œë”© í™”ë©´ í‘œì‹œ(íˆìŠ¤í† ë¦¬ ì¶”ê°€ ì—†ìŒ)
            teardownMuichiro();
            teardownGiyu();
            clearPasswordLoadingTimer();
            show('loadingScreen');
            document.title = 'ì ì‹œë§Œìš”â€¦ ë¹„ë°€ë²ˆí˜¸ ì—¬ëŠ” ì¤‘';
            document.body.classList.remove('celebrate');
            // ì ì‹œ í›„ ë¹„ë°€ë²ˆí˜¸ í™”ë©´ìœ¼ë¡œ ì´ë™
            passwordLoadingTimer = setTimeout(() => {
                passwordLoadingTimer = null;
                goToPassword();
            }, 900);
        }
        function goToCharacter(slug) {
            const c = characters.find(x => x.slug === slug);
            if (!c) return;
            ensureCharacterScreensOnce();
            show(`char-${slug}`);
            document.title = `${c.label} Â· ë‹¤ìŒ ì§ˆë¬¸`;
            if (history.pushState) {
                history.pushState({screen: 'char', slug}, '', `#char/${slug}`);
            }
            // ë¨¼ì € ëª¨ë‘ ì •ë¦¬ í›„ í•´ë‹¹ ìºë¦­í„° ì´ˆê¸°í™”
            teardownMuichiro();
            teardownGiyu();
            if (slug === 'tokito-muichiro') {
                initMuichiroScreen();
            } else if (slug === 'tomioka-giyu') {
                initGiyuScreen();
            } else if (slug === 'kamado-tanjiro') {
                // íƒ„ì§€ë¡œ í™”ë©´ ì§„ì… ì‹œ ë§¤ë²ˆ ì •ë‹µ/í”¼ë“œë°± ì´ˆê¸°í™”
                const feedback = document.getElementById('tanjiro-feedback');
                if (feedback) feedback.textContent = '';
            } else if (slug === 'kamado-nezuko') {
                // ë„¤ì¦ˆì½” í™”ë©´ ì§„ì… ì‹œ ë§¤ë²ˆ í”¼ë“œë°± ì´ˆê¸°í™”
                const nfb = document.getElementById('nezuko-feedback');
                if (nfb) nfb.textContent = '';
            }
            document.body.classList.remove('celebrate');
            clearPasswordLoadingTimer();
        }
        function goToPassword() {
            // ë¹„ë°€ë²ˆí˜¸ ê³µê°œ í™”ë©´ìœ¼ë¡œ ì´ë™
            clearPasswordLoadingTimer();
            show('passwordScreen');
            document.title = 'ë¹„ë°€ë²ˆí˜¸ ê³µê°œ!';
            // ë’¤ë¡œê°€ê¸°ë¥¼ ëˆ„ë¥´ë©´ ìºë¦­í„° ì„ íƒ(#question)ìœ¼ë¡œ ê°€ë„ë¡ íˆìŠ¤í† ë¦¬ ì¬ë°°ì¹˜
            // í˜„ì¬ í•­ëª©(#char/...)ì„ #questionìœ¼ë¡œ ëŒ€ì²´í•œ ë’¤, #passwordë¥¼ í‘¸ì‹œí•©ë‹ˆë‹¤.
            if (history.replaceState) {
                try { history.replaceState({screen: 'question'}, '', '#question'); } catch {}
            }
            if (history.pushState) {
                history.pushState({screen: 'password'}, '', '#password');
            }
            teardownMuichiro();
            teardownGiyu();
            document.body.classList.add('celebrate');
            // ì¶œì²˜ì— ë”°ë¥¸ ì•ˆë‚´ ë¬¸êµ¬ ë³€ê²½
            const subtitle = document.getElementById('password-subtitle');
            if (subtitle) {
                if (lastPasswordSource === 'tanjiro' || lastPasswordSource === 'nezuko') {
                    subtitle.textContent = 'ì •ë‹µì„ ë§ì·„êµ°ìš”!';
                } else if (lastPasswordSource === 'giyu') {
                    subtitle.textContent = 'ë¬¼ì˜ í˜¸í¡ ì£¼ë¬¸ì„ ì„±ê³µì ìœ¼ë¡œ ì‚¬ìš©í–ˆë„¤ìš”!';
                } else {
                    // ê¸°ë³¸(ë¬´ì´ì¹˜ë¡œ ë“±): ì•ˆê°œì˜ í˜¸í¡
                    subtitle.textContent = 'ì•ˆê°œì˜ í˜¸í¡ ì£¼ë¬¸ì„ ì„±ê³µì ìœ¼ë¡œ ì‚¬ìš©í–ˆë„¤ìš”!';
                }
            }
            // ì‚¬ìš© í›„ ì´ˆê¸°í™”í•˜ì—¬ ë‹¤ìŒ ì§„ì… ì‹œ ì˜¤ì—¼ ë°©ì§€
            lastPasswordSource = null;
            // ì ‘ê·¼ì„±: ì œëª©ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
            const h = document.getElementById('password-title');
            if (h) {
                h.setAttribute('tabindex', '-1');
                h.focus({preventScroll: true});
            }
        }
        function goToQuestion() {
            show('questionScreen');
            // document.title = 'ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìºë¦­í„°';
            document.title = 'ì‹œìœ ë‹ˆì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•Œì•„ë‚´ë¼';
            if (history.pushState) {
                history.pushState({screen: 'question'}, '', '#question');
            }
            renderChoicesOnce();
            teardownMuichiro();
            teardownGiyu();
            document.body.classList.remove('celebrate');
            clearPasswordLoadingTimer();
        }
        function routeByHash() {
            const h = location.hash || '';
            if (h === '#password') {
                clearPasswordLoadingTimer();
                show('passwordScreen');
                document.title = 'ë¹„ë°€ë²ˆí˜¸ ê³µê°œ!';
                teardownMuichiro();
                teardownGiyu();
                document.body.classList.add('celebrate');
                // ì§ì ‘ ì§„ì… ì‹œ ê¸°ë³¸ ë¬¸êµ¬ ìœ ì§€
                const subtitle = document.getElementById('password-subtitle');
                if (subtitle) subtitle.textContent = 'ì•ˆê°œì˜ í˜¸í¡ ì£¼ë¬¸ì„ ì„±ê³µì ìœ¼ë¡œ ì‚¬ìš©í–ˆë„¤ìš”!';
                lastPasswordSource = null;
                return;
            }
            if (h === '#question') {
                clearPasswordLoadingTimer();
                show('questionScreen');
                renderChoicesOnce();
                // document.title = 'ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìºë¦­í„°';
                document.title = 'ì‹œìœ ë‹ˆì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•Œì•„ë‚´ë¼';
                teardownMuichiro();
                teardownGiyu();
                document.body.classList.remove('celebrate');
                return;
            }
            if (h.startsWith('#char/')) {
                const slug = h.split('/')[1]?.replace(/^#char/, '').replace(/^\//, '') || '';
                if (slug) {
                    ensureCharacterScreensOnce();
                    const exists = characters.some(c => c.slug === slug);
                    if (exists) {
                        clearPasswordLoadingTimer();
                        show(`char-${slug}`);
                        const c = characters.find(c => c.slug === slug);
                        document.title = `${c.label} Â· ë‹¤ìŒ ì§ˆë¬¸`;
                        // ëª¨ë‘ ì •ë¦¬ í›„ í•´ë‹¹ ìºë¦­í„° ì´ˆê¸°í™”
                        teardownMuichiro();
                        teardownGiyu();
                        if (slug === 'tokito-muichiro') {
                            initMuichiroScreen();
                        } else if (slug === 'tomioka-giyu') {
                            initGiyuScreen();
                        } else if (slug === 'kamado-tanjiro') {
                            // í•´ì‹œë¡œ ì§ì ‘ ì§„ì…/ë’¤ë¡œê°€ê¸°ë¡œ ì§„ì… ì‹œì—ë„ í”¼ë“œë°± ì´ˆê¸°í™”
                            const feedback = document.getElementById('tanjiro-feedback');
                            if (feedback) feedback.textContent = '';
                        } else if (slug === 'kamado-nezuko') {
                            // ë„¤ì¦ˆì½” í™”ë©´ ì§„ì… ì‹œ í”¼ë“œë°± ì´ˆê¸°í™”
                            const nfb = document.getElementById('nezuko-feedback');
                            if (nfb) nfb.textContent = '';
                        }
                        document.body.classList.remove('celebrate');
                        return;
                    }
                }
            }
            show('homeScreen');
            document.title = 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼';
            teardownMuichiro();
            teardownGiyu();
            document.body.classList.remove('celebrate');
            clearPasswordLoadingTimer();
        }
        window.addEventListener('popstate', routeByHash);
        window.addEventListener('DOMContentLoaded', () => {
            renderChoicesOnce();
            ensureCharacterScreensOnce();
            routeByHash();
        });
        // íƒ„ì§€ë¡œ í€´ì¦ˆ ì •ë‹µ ì²˜ë¦¬: 2ë²ˆë§Œ ì„±ê³µ â†’ ë¡œë”© â†’ ë¹„ë°€ë²ˆí˜¸ í™”ë©´
        function handleTanjiroAnswer(choice) {
            const feedback = document.getElementById('tanjiro-feedback');
            if (Number(choice) === 2) {
                if (feedback) feedback.textContent = 'ì •ë‹µ! ğŸ‰';
                // ì¶œì²˜ í‘œì‹œ: íƒ„ì§€ë¡œ ì •ë‹µ ê²½ë¡œ
                lastPasswordSource = 'tanjiro';
                // ë¹„ë°€ë²ˆí˜¸ ê³µê°œ ì „ ë¡œë”© í™”ë©´ìœ¼ë¡œ ì´ë™
                showLoadingBeforePassword();
            } else {
                if (feedback) feedback.textContent = 'ì˜ ìƒê°í•´ë³´ì„¸ìš”! ã…ã…ã…';
            }
        }
        // ë„¤ì¦ˆì½” í€´ì¦ˆ ì •ë‹µ ì²˜ë¦¬: 3ë²ˆë§Œ ì„±ê³µ â†’ ë¡œë”© â†’ ë¹„ë°€ë²ˆí˜¸ í™”ë©´
        function handleNezukoAnswer(choice) {
            const feedback = document.getElementById('nezuko-feedback');
            if (Number(choice) === 3) {
                if (feedback) feedback.textContent = 'ì •ë‹µ! ğŸ‰';
                lastPasswordSource = 'nezuko';
                showLoadingBeforePassword();
            } else {
                if (feedback) feedback.textContent = 'ì˜ ìƒê°í•´ë³´ì„¸ìš”!ã…ã…ã…';
            }
        }
    </script>
    <meta name="theme-color" content="#e11d48" />
</head>
<body>
    <!-- ì²« í™”ë©´ -->
    <main id="homeScreen" class="screen active">
        <div class="center">
            <div class="card" role="region" aria-labelledby="main-title">
                <h1 id="main-title">ë©”ë¦¬ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ğŸ„</h1>
                <p class="subtle">ì„ ë¬¼ì„ ì—´ê¸° ì „ì— ë¹„ë°€ ë¯¸ì…˜ì´ ìˆì–´ìš”!</p>
                <div class="hero-wrap" aria-hidden="false">
                    <img
                        src="images/main.png"
                        alt="í¬ë¦¬ìŠ¤ë§ˆìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ë°˜ì§ì´ëŠ” ì„ ë¬¼ ì´ë¯¸ì§€"
                        class="hero-img"
                        decoding="async"
                        fetchpriority="high"
                    />
                </div>
                <button type="button" class="primary-btn" onclick="goToQuestion()">ì„ ë¬¼ì˜ ë¹„ë°€ë²ˆí˜¸ ì•Œì•„ë‚´ê¸° Go Go!</button>
            </div>
        </div>
    </main>

    <!-- ì§ˆë¬¸ í™”ë©´ -->
    <main id="questionScreen" class="screen" aria-live="polite">
        <div class="center">
            <div class="card" role="region" aria-labelledby="question-title">
                <h1 id="question-title" class="question">ì‹œìœ ë‹ˆê°€ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìºë¦­í„°ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”</h1>
                <div id="choicesContainer" class="choices-grid" role="listbox" aria-label="ìºë¦­í„° ì„ íƒ"></div>
            </div>
        </div>
    </main>

    <!-- ë¹„ë°€ë²ˆí˜¸ ê³µê°œ í™”ë©´ -->
    <main id="passwordScreen" class="screen" aria-live="polite">
        <div class="center">
            <div class="card" role="region" aria-labelledby="password-title">
                <h1 id="password-title">ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰ <br>ë¹„ë°€ë²ˆí˜¸ ê³µê°œ</h1>
                <p id="password-subtitle" class="subtle">ì•ˆê°œì˜ í˜¸í¡ ì£¼ë¬¸ì„ ì„±ê³µì ìœ¼ë¡œ ì‚¬ìš©í–ˆë„¤ìš”!</p>
                <div class="pw-fireworks" aria-hidden="true">âœ¨ğŸŠğŸ‰</div>
                <div class="pw-box" aria-label="ë¹„ë°€ë²ˆí˜¸ëŠ” 1 1 7 ì…ë‹ˆë‹¤">
                    <span class="digit">1</span>
                    <span class="digit">1</span>
                    <span class="digit">7</span>
                </div>
                <p class="subtle">ë’¤ë¡œê°€ê¸°ë¡œ ìºë¦­í„° ì„ íƒìœ¼ë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆì–´ìš”.</p>
            </div>
        </div>
    </main>
</body>
</html>
