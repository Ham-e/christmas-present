<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼ì„ ìœ„í•˜ì—¬</title>
    <style>
        :root {
            color-scheme: light dark;
        }
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            background: #f6f8fa;
            color: #222;
        }
        .screen {
            display: none;
            min-height: 100%;
        }
        .screen.active { display: flex; }
        .center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .card {
            width: 100%;
            max-width: 560px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            padding: 24px;
            text-align: center;
        }
        h1 {
            margin: 0 0 16px;
            font-size: 24px;
        }
        p { margin: 0 0 24px; font-size: 16px; }
        .primary-btn {
            display: inline-block;
            padding: 14px 20px;
            font-size: 18px;
            font-weight: 700;
            background: #e11d48; /* rose-600 */
            color: #fff;
            border: none;
            border-radius: 999px;
            width: 100%;
            max-width: 360px;
            cursor: pointer;
            transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
            box-shadow: 0 6px 14px rgba(225, 29, 72, 0.35);
        }
        .primary-btn:active { transform: translateY(1px); }
        .question {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .subtle { color: #6b7280; font-size: 14px; }
        /* ì„ íƒì§€ ê·¸ë¦¬ë“œ */
        .choices-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        .choice-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            color: inherit;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
        }
        .choice-btn:focus { outline: 3px solid #fb7185; outline-offset: 2px; }
        .choice-btn:active { transform: translateY(1px); }
        .choice-btn img {
            width: 100%;
            height: auto;
            max-height: 160px;
            object-fit: contain;
        }
        .choice-caption {
            margin-top: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        @media (prefers-color-scheme: dark) {
            html, body { background: #0b0f14; color: #e5e7eb; }
            .card { background: #111827; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
            .subtle { color: #9ca3af; }
            .choice-btn { background: #0f172a; border-color: #334155; }
        }
        /* ìŒì„± ì¸ì‹ UI (ë¬´ì´ì¹˜ë¡œ ì „ìš©) */
        .record-wrap { margin-top: 16px; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .record-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 999px;
            border: none;
            background: #ef4444; /* red-500 */
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(239, 68, 68, .35);
            transition: transform .05s ease, background .2s ease, box-shadow .2s ease;
        }
        .record-btn:active { transform: translateY(1px); }
        .record-btn[disabled] { opacity: .6; cursor: not-allowed; box-shadow: none; }
        .status-text { font-size: 14px; color: #6b7280; }
        .transcript {
            width: 100%;
            text-align: left;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            min-height: 72px;
            white-space: pre-wrap;
        }
        @media (prefers-color-scheme: dark) {
            .transcript { background: #0f172a; border-color: #334155; }
        }
    </style>
    <script>
        function show(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            const el = document.getElementById(screenId);
            if (el) el.classList.add('active');
        }
        const characters = [
            { slug: 'kamado-nezuko', src: 'images/characters/kamado_nezuko.png', label: 'ì¹´ë§ˆë„ ë„¤ì¦ˆì½”', nextQuestion: 'ë„¤ì¦ˆì½”ë¥¼ ì¢‹ì•„í•˜ëŠ” ê°€ì¥ í° ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?' },
            { slug: 'kamado-tanjiro', src: 'images/characters/kamado_tanjiro.png', label: 'ì¹´ë§ˆë„ íƒ„ì§€ë¡œ', nextQuestion: 'íƒ„ì§€ë¡œì²˜ëŸ¼ ì°©í•œ í–‰ë™ í•œ ê°€ì§€ë¥¼ ì ì–´ë³¼ê¹Œìš”?' },
            { slug: 'tokito-muichiro', src: 'images/characters/tokito_muichiro.png', label: 'í† í‚¤í†  ë¬´ì´ì¹˜ë¡œ', nextQuestion: 'ë¬´ì´ì¹˜ë¡œì˜ ë§¤ë ¥ í¬ì¸íŠ¸ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?' },
            { slug: 'tomioka-giyu', src: 'images/characters/tomioka_giyu.png', label: 'í† ë¯¸ì˜¤ì¹´ ê¸°ìœ ', nextQuestion: 'ê¸°ìœ ì˜ ê°€ì¥ ë©‹ì§„ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?' },
        ];

        // Web Speech API (ë¬´ì´ì¹˜ë¡œ ì „ìš©)
        let muichiroRecognition = null;
        let muichiroRecognizing = false;
        let muichiroBound = false;

        function getSpeechRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return null;
            if (muichiroRecognition) return muichiroRecognition;
            const rec = new SR();
            rec.lang = 'ko-KR';
            rec.interimResults = true;
            rec.continuous = true;

            const statusEl = () => document.getElementById('muichiro-status');
            const btnEl = () => document.getElementById('muichiro-record-btn');
            const outEl = () => document.getElementById('muichiro-transcript');

            rec.onstart = () => {
                muichiroRecognizing = true;
                if (statusEl()) statusEl().textContent = 'ë…¹ìŒ ì¤‘â€¦ ì•ˆê°œì˜ í˜¸í¡ì„ ìŠì–´ë³´ì•„ìš”!';
                if (btnEl()) btnEl().textContent = 'ë…¹ìŒ ì¤‘ì§€';
            };
            rec.onend = () => {
                muichiroRecognizing = false;
                if (statusEl()) statusEl().textContent = 'ì¸ì‹ ì¢…ë£Œë¨';
                if (btnEl()) btnEl().textContent = 'ë…¹ìŒ ì‹œì‘';
            };
            rec.onerror = (e) => {
                if (statusEl()) statusEl().textContent = `ì˜¤ë¥˜: ${e.error || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
            };
            rec.onresult = (event) => {
                let finalText = '';
                let interimText = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const res = event.results[i];
                    if (res.isFinal) finalText += res[0].transcript;
                    else interimText += res[0].transcript;
                }
                const out = outEl();
                if (out) {
                    const base = out.dataset.base || '';
                    out.textContent = (base + ' ' + finalText + (interimText ? ' ' + interimText : '')).trim();
                }
            };
            muichiroRecognition = rec;
            return rec;
        }

        function muichiroToggleRecording() {
            const rec = getSpeechRecognition();
            const btn = document.getElementById('muichiro-record-btn');
            const status = document.getElementById('muichiro-status');
            if (!rec) {
                if (status) status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš” ğŸ˜¢ (Chrome/Android ê¶Œì¥)';
                if (btn) btn.disabled = true;
                return;
            }
            if (muichiroRecognizing) {
                try { rec.stop(); } catch {}
            } else {
                try {
                    // iOS Safari ë“±ì€ ì‚¬ìš©ì ì œìŠ¤ì²˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ
                    rec.start();
                } catch (e) {
                    if (status) status.textContent = 'ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
            }
        }

        function initMuichiroScreen() {
            // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
            const btn = document.getElementById('muichiro-record-btn');
            const status = document.getElementById('muichiro-status');
            const out = document.getElementById('muichiro-transcript');
            if (!btn || !status || !out) return;

            // í•œ ë²ˆë§Œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            if (!muichiroBound) {
                btn.addEventListener('click', muichiroToggleRecording);
                muichiroBound = true;
            }
            // ì´ˆê¸° ìƒíƒœ ë¦¬ì…‹
            status.textContent = 'ëŒ€ê¸° ì¤‘';
            btn.textContent = 'ë…¹ìŒ ì‹œì‘';
            btn.disabled = false;
            out.textContent = '';

            // ì§€ì› ì—¬ë¶€ í‘œì‹œ
            if (!getSpeechRecognition()) {
                status.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš” ğŸ˜¢ (Chrome/Android ê¶Œì¥)';
                btn.disabled = true;
            }
        }

        function teardownMuichiro() {
            if (muichiroRecognition && muichiroRecognizing) {
                try { muichiroRecognition.stop(); } catch {}
            }
        }

        function ensureCharacterScreensOnce() {
            // ê° ìºë¦­í„° ì „ìš© ì§ˆë¬¸ í™”ë©´ì„ 1íšŒë§Œ ìƒì„±
            if (document.body.dataset.charScreens === 'true') return;
            const frag = document.createDocumentFragment();
            characters.forEach(c => {
                const main = document.createElement('main');
                main.id = `char-${c.slug}`;
                main.className = 'screen';
                main.setAttribute('aria-live', 'polite');
                if (c.slug === 'tokito-muichiro') {
                    main.innerHTML = `
                        <div class="center">
                            <div class="card" role="region" aria-labelledby="title-${c.slug}">
                                <h1 id="title-${c.slug}" class="question">ì¢‹ì•„ìš”! â€œ${c.label}â€ë¥¼ ì„ íƒí–ˆë„¤ìš”</h1>
                                <p class="subtle">ì‹œìœ ë‹ˆê°€ í† í‚¤í†  ë¬´ì´ì¹˜ë¡œë¼ê³  ìƒê°í–ˆì„ ë•Œ, <br> ì„ ë¬¼ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•Œì•„ë‚´ê¸°ìœ„í•œ ì•ˆê°œì˜ í˜¸í¡ ì£¼ë¬¸ì„ ìŠì–´ë³´ì!</p>
                                <div class="record-wrap">
                                    <button id="muichiro-record-btn" type="button" class="record-btn" aria-live="polite">ë…¹ìŒ ì‹œì‘</button>
                                    <div id="muichiro-status" class="status-text" aria-live="polite">ëŒ€ê¸° ì¤‘</div>
                                    <div id="muichiro-transcript" class="transcript" role="textbox" aria-label="ì¸ì‹ëœ ì£¼ë¬¸ í…ìŠ¤íŠ¸"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    main.innerHTML = `
                        <div class="center">
                            <div class="card" role="region" aria-labelledby="title-${c.slug}">
                                <h1 id="title-${c.slug}" class="question">ì¢‹ì•„ìš”! â€œ${c.label}â€ë¥¼ ì„ íƒí–ˆë„¤ìš”</h1>
                                <p class="subtle">ë‹¤ìŒ ì§ˆë¬¸: ${c.nextQuestion}</p>
                            </div>
                        </div>
                    `;
                }
                frag.appendChild(main);
            });
            document.body.appendChild(frag);
            document.body.dataset.charScreens = 'true';
        }

        function renderChoicesOnce() {
            const container = document.getElementById('choicesContainer');
            if (!container || container.dataset.rendered === 'true') return;
            const frag = document.createDocumentFragment();
            characters.forEach((c, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'choice-btn';
                btn.setAttribute('role', 'option');
                btn.setAttribute('aria-label', c.label);
                btn.dataset.index = String(idx);
                const img = document.createElement('img');
                img.src = c.src;
                img.alt = c.label;
                const cap = document.createElement('div');
                cap.className = 'choice-caption';
                cap.textContent = c.label;
                btn.appendChild(img);
                btn.appendChild(cap);
                btn.addEventListener('click', () => {
                    // ì„ íƒ ì‹œ ìºë¦­í„° ì „ìš© ì§ˆë¬¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                    goToCharacter(c.slug);
                });
                frag.appendChild(btn);
            });
            container.appendChild(frag);
            container.dataset.rendered = 'true';
        }
        function goToCharacter(slug) {
            const c = characters.find(x => x.slug === slug);
            if (!c) return;
            ensureCharacterScreensOnce();
            show(`char-${slug}`);
            document.title = `${c.label} Â· ë‹¤ìŒ ì§ˆë¬¸`;
            if (history.pushState) {
                history.pushState({screen: 'char', slug}, '', `#char/${slug}`);
            }
            if (slug === 'tokito-muichiro') initMuichiroScreen(); else teardownMuichiro();
        }
        function goToQuestion() {
            show('questionScreen');
            document.title = 'ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìºë¦­í„°';
            if (history.pushState) {
                history.pushState({screen: 'question'}, '', '#question');
            }
            renderChoicesOnce();
            teardownMuichiro();
        }
        function routeByHash() {
            const h = location.hash || '';
            if (h === '#question') {
                show('questionScreen');
                renderChoicesOnce();
                document.title = 'ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìºë¦­í„°';
                teardownMuichiro();
                return;
            }
            if (h.startsWith('#char/')) {
                const slug = h.split('/')[1]?.replace(/^#char/, '').replace(/^\//, '') || '';
                if (slug) {
                    ensureCharacterScreensOnce();
                    const exists = characters.some(c => c.slug === slug);
                    if (exists) {
                        show(`char-${slug}`);
                        const c = characters.find(c => c.slug === slug);
                        document.title = `${c.label} Â· ë‹¤ìŒ ì§ˆë¬¸`;
                        if (slug === 'tokito-muichiro') initMuichiroScreen(); else teardownMuichiro();
                        return;
                    }
                }
            }
            show('homeScreen');
            document.title = 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼';
            teardownMuichiro();
        }
        window.addEventListener('popstate', routeByHash);
        window.addEventListener('DOMContentLoaded', () => {
            renderChoicesOnce();
            ensureCharacterScreensOnce();
            routeByHash();
        });
    </script>
    <meta name="theme-color" content="#e11d48" />
</head>
<body>
    <!-- ì²« í™”ë©´ -->
    <main id="homeScreen" class="screen active">
        <div class="center">
            <div class="card" role="region" aria-labelledby="main-title">
                <h1 id="main-title">ë©”ë¦¬ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ğŸ„</h1>
                <p class="subtle">ì„ ë¬¼ì„ ì—´ê¸° ì „ì— ë¹„ë°€ ë¯¸ì…˜ì´ ìˆì–´ìš”!</p>
                <button type="button" class="primary-btn" onclick="goToQuestion()">ì„ ë¬¼ì˜ ë¹„ë°€ë²ˆí˜¸ ì•Œì•„ë‚´ê¸° Go Go!</button>
            </div>
        </div>
    </main>

    <!-- ì§ˆë¬¸ í™”ë©´ -->
    <main id="questionScreen" class="screen" aria-live="polite">
        <div class="center">
            <div class="card" role="region" aria-labelledby="question-title">
                <h1 id="question-title" class="question">ì‹œìœ ë‹ˆê°€ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìºë¦­í„°ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”</h1>
                <div id="choicesContainer" class="choices-grid" role="listbox" aria-label="ìºë¦­í„° ì„ íƒ"></div>
            </div>
        </div>
    </main>
</body>
</html>
